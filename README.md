# Детали реализации

Телеграм бот реализован с помощью библиотеки [TelegramBots](https://github.com/rubenlagus/TelegramBots)

Библиотека в фоновом процессе занимается поллингом всех обновлений, адресованных боту, и прокидывает список updates в
метод `onUpdatesReceived()` класса `Bot`. Здесь имеет место логика, которая обрабатывает отдельно посты из каналов и
отдельно сообщения из чата.

Логика по умолчанию для каждого отдельного update вызывала `onUpdateReceive()`. Такой подход нас не устраивал, так как
контент поста может прийти несколькими сообщениями (имеют один media_group_id - термин из апи
телеграма).

### Обработка постов

* Адпейты, являющиеся постами, мы прокидываем в метод `processPostsInChannel()` класса `PostsProcessor`. Здесь мы их
  группируем по id канала и отдельно обрабатываем опубликованный контент для каждого телеграмм канала;
* Скачиваем контент постов;
* Понимаем, какие группы связанны с этим каналом, извлекаем accessToken аккаунта владельца этих групп;
* Выполняем логику (возможно специфичную) по загрузке контента в социальную сеть и публикации поста.
  Метод `processPostInChannel()` у `IPostProcessor` через обёртки и классы с названием Poster обращается к модулям,
  отвечающим за взаимодействие с апи конкретной социальной сети.

Имеем модули:

* `ok-api` - наша реализация взаимодействия с апи социальной сети `Одноклассники`;
* `vk-api` - обёртка над `vk-api-sdk`, взаимодействие с социальной сетью `ВКонтакте`;
* `api-rate-limiter` - наша простая реализация rate limiter, которая помогает ограничить число публикаций от
  пользователя в единицу времени (и, соответственно, обращения к апи соцсетей).

### Обработка пришедших боту сообщений

Прийти могут:

- Команды, зарегистрированные путём использования метода `register()` класса `Bot`. Их обработчик - 
  класс-наследник `BotCommand` с логикой обработки команды в методе `execute()` - можно достать
  методом `getRegisteredCommand()` - просто маппинг по идентификатору команды.
- Текстовое сообщение. Может содержать **код авторизации, ссылку на группу, ссылку на канал**. Нужно понимать, на каком
  этапе общения с ботом находится пользователь, и правильно интерпретировать его сообщение.
- Callback data - данные со встроенных в сообщение кнопок. Формат - разделённые пробелами данные о нажатой группе,
  канале, аккаунте. Мы прокидываем id сущности (канал, группа, аккаунт), название соцсети, признак того, что запрошено
  удаление сущности и т.п.

# Запуск

Настроить проперти в файле application.properties. [Пример](application.properties.demo)

Запуск при помощи docker:

```
docker-compose up
```

# Использование

[Граф состояний бота](https://www.figma.com/file/CSHh8AkIMLO2KSb3yvQDBD/Телеграм-бот-авто-постинга?type=design&node-id=0-1)

# Особенности и ограничения

* Один пользователь может работать с несколькими Телеграм-каналами;
* Один пользователь может работать с несколькими социальными сетями;
* Один пользователь может работать с несколькими аккаунтами в пределах одной социальной сети;
* Один пользователь может работать с несколькими группами в пределах одного аккаунта (пользователь является
  администратором данных групп);
* Публикация постов для каждого Телеграм-канала может быть связана не более, чем с одной группой в каждой из социальных
  сетей;
* Публикация контента, являющейся чужой собственностью (пересылаемые сообщения или посты других пользователей), не
  осуществляется по причине соблюдения авторских прав;
* Публикация из закрытых Телеграм-каналов, а также публикация в закрытые группы социальных сетей не осуществляется по
  причине ограничений посещаемости таких групп и каналов.
* Поддерживаемый тип медиа-файлов в социальных сетях:
    * Фотографии;
    * Видео;
    * Опросы;
    * Текст;
    * Текстовые ссылки;
    * Документы (только ВКонтакте).




